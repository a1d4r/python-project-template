# Global --------------------------

variables:
  # GitLab CI creates a separate mountpoint for the build directory,
  # so we need to copy instead of using hard links.
  UV_LINK_MODE: copy
  UV_CACHE_DIR: .uv-cache

cache:
  - key:
      files:
        - uv.lock
    paths:
      - $UV_CACHE_DIR

stages:
  - quality
  - tests

# Jobs templates ------------------

.install-deps-template: &install-deps
  image: python:{{ cookiecutter.python_version }}
  before_script:
    - pip install uv==0.8.14
    - uv --version
    - uv sync --dev
  after_script:
    - uv cache prune --ci

.quality-template: &quality
  <<: *install-deps
  stage: quality

# Quality jobs ----------------------

check-dependencies:
  <<: *quality
  script: make check-dependencies

check-codestyle:
  <<: *quality
  script: make check-codestyle

check-ruff:
  <<: *quality
  script: make check-ruff-gitlab
  artifacts:
    reports:
      codequality: ruff-report.json
    when: always
    expire_in: 1 week

check-mypy:
  <<: *quality
  script: make check-mypy-gitlab
  artifacts:
    reports:
      codequality: mypy-report.json
    when: always
    expire_in: 1 week

check-safety:
  <<: *quality
  script: make check-safety
  allow_failure: true

check-deptry:
  <<: *quality
  script: make check-deptry

# Tests jobs ------------------------

test:
  <<: *install-deps
  stage: tests
  coverage: '/TOTAL.*\s(\d+\.\d+\%)/'
  script: make test
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: reports/coverage.xml
      junit: reports/junit.xml
    when: always
    expire_in: 1 week
